---
title: "Classification and Quantifying Of Change In Land Use With Time Series In Ghana"
author: "Kalong Boniface 
         "
date: '`r Sys.Date()`'
output: pdf_document
toc: true
toc_depth: 2
number_sections: true
fig_width: 7
fig_height: 6
fig_caption: true
df_print: kable
fontsize: 12pt

template: quarterly-report.tex
header-includes:
  - \setmainfont{Times New Roman}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Install and load sf, after that, initialize the Earth Engine R API.
library(reticulate)
library(magick)
library(rgee)
library('sf')
library(sf)

```
```{r}
ee_Initialize()
```
#Define the regional bounds of animation frames and a mask to clip the NDVI data by.
```{r}
mask <- read_sf("Ghana shp file/New Regions/New_Regions.shp")%>% 
sf_as_ee()



region <- mask$geometry()$bounds()

```
#Retrieve the MODIS Terra Vegetation Indices 16-Day Global 1km dataset as an ee.ImageCollection and select the NDVI band.
```{r}
col <- ee$ImageCollection('MODIS/006/MOD13A2')$select('NDVI')
```
#Group images by composite date
```{r}
col <- col$map(function(img) {
  doy <- ee$Date(img$get('system:time_start'))$getRelative('day', 'year')
  img$set('doy', doy)
})
distinctDOY <- col$filterDate('2000-01-01', '2022-01-01')
```
#Define a filter that identifies which images from the complete collection match the DOY from the distinct DOY collection.
```{r}
filter <- ee$Filter$equals(leftField = 'doy', rightField = 'doy')
```
#Define a join; convert the resulting FeatureCollection to an ImageCollection.
```{r}
join <- ee$Join$saveAll('doy_matches')
joinCol <- ee$ImageCollection(join$apply(distinctDOY, col, filter))
```
#Apply median reduction among matching DOY collections.
```{r}
comp <- joinCol$map(function(img) {
  doyCol = ee$ImageCollection$fromImages(
    img$get('doy_matches')
  )
  doyCol$reduce(ee$Reducer$median())
})
```
#Define RGB visualization parameters.
```{r}
visParams = list(
  min = 0.0,
  max = 9000.0,
  bands = "NDVI_median",
  palette = c(
    'FFFFFF', 'CE7E45', 'DF923D', 'F1B555', 'FCD163', '99B718', '74A901',
    '66A000', '529400', '3E8601', '207401', '056201', '004C00', '023B01',
    '012E01', '011D01', '011301'
  )
)
```
#Create RGB visualization images for use as animation frames.
```{r}
rgbVis <- comp$map(function(img) {
  do.call(img$visualize, visParams) %>%
    ee$Image$clip(mask)
})
```
#Define GIF visualization parameters.
```{r}
gifParams <- list(
  region = region,
  dimensions = 600,
  crs = 'EPSG:3857',
  framesPerSecond = 10
)
```
#Get month names
```{r}
dates_modis_mabbr <- distinctDOY %>%
  ee_get_date_ic %>% # Get Image Collection dates
  '[['("time_start") %>% # Select time_start column
  lubridate::month() %>% # Get the month component of the datetime
  '['(month.abb, .) # subset around month abbreviations
```
#Use ee_utils_gif_* functions to render the GIF animation and add some texts.
```{r}
animation <- ee_utils_gif_creator(rgbVis, gifParams, mode = "wb")
animation %>%
  ee_utils_gif_annotate(
    text = "NDVI: MODIS/006/MOD13A2",
    size = 15, color = "white",
    location = "+10+10"
  ) %>%
  ee_utils_gif_annotate(
    text = dates_modis_mabbr,
    size = 30,
    location = "+290+350",
    color = "white",
    font = "arial",
    boxcolor = "#000000"
  ) 
# -> animation_wtxt

# ee_utils_gif_save(animation_wtxt, path = "raster_as_ee.gif")
```
    
    